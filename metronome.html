<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8">
  <title>Metronome</title>
  <link rel="stylesheet" href="metronome.css">

  <script>
    window.console = window.console || function(t) {};
  </script>
</head>

<body translate="no" >
  <div class="container">
  <header>Simple<b style="color: #FFF;">Metronome</b></header>

  <section class="metronome-container">
    <div class="counter"></div>
    
    <i class="fa fa-cog options-btn"></i>

    <div class="controls">
      <label>BPM: <span>
                    <i class="fa fa-minus bpm-minus"></i>
                    <input type="text" value="60" class="bpm-input" />
                    <i class="fa fa-plus bpm-plus"></i>
                  </span>
      </label>
      <label>
        Beat: <input type="text" value="4" class="ts-top" /></label>
      <div style="margin-bottom: 15px;">
        <input type="checkbox" id="timer-check" />
        <label for="timer-check"></label>
        
        Timer: <input type="text" value="60" class="timer" />
      </div>

      <button class="tap-btn">Tap</button>
      <button class="play-btn">Play</button>
    </div>
    
    <div class="options">
      <i class="fa fa-caret-down up"></i>
      <label>Off Beat Pitch: <input type="range" min="0" max="500" value="200" class="beat-range" /></label>
      <label>Accent Pitch: <input type="range" min="0" max="500" value="380" class="accent-range" /></label>
    </div>
  </section>
</div>

<footer>
  <ul>
    <li>Click circles to make an accent on that beat</li>
    <li>Best viewed in <b>Google Chrome</b></li>
    <li>Use options to change pitches of beats.</li>
  </ul>
</footer>
    <script src="https://cpwebassets.codepen.io/assets/common/stopExecutionOnTimeout-1b93190375e9ccc259df3a57c1abc0e64599724ae30d7ea4c6877eb615f89387.js"></script>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/FitText.js/1.1/jquery.fittext.min.js'></script>
      <script id="rendered-js" >
window.AudioContext = window.AudioContext || window.webkitAudioContext;
var context = new AudioContext();
var timer,noteCount,counting,accentPitch = 380,offBeatPitch = 200;
var delta = 0;
var curTime = 0.0;

// Load up dots on pageload
$("document").ready(function () {
  $(".ts-top").trigger("change");
  $("header").fitText(1, { maxFontSize: "46px" });
});


/*
Scheduling Help by: https://www.html5rocks.com/en/tutorials/audio/scheduling/
*/
function schedule() {
  while (curTime < context.currentTime + 0.1) {if (window.CP.shouldStopExecution(0)) break;
    playNote(curTime);
    updateTime();
  }window.CP.exitedLoop(0);
  timer = window.setTimeout(schedule, 0.1);
}

function updateTime() {
  curTime += 60.0 / parseInt($(".bpm-input").val(), 10);
  noteCount++;
}

/* Play note on a delayed interval of t */
function playNote(t) {
  var note = context.createOscillator();

  if (noteCount == parseInt($(".ts-top").val(), 10))
  noteCount = 0;

  if ($(".counter .dot").eq(noteCount).hasClass("active"))
  note.frequency.value = accentPitch;else

  note.frequency.value = offBeatPitch;

  note.connect(context.destination);

  note.start(t);
  note.stop(t + 0.05);

  $(".counter .dot").attr("style", "");

  $(".counter .dot").eq(noteCount).css({
    transform: "translateY(-10px)",
    background: "#F75454" });

}

function countDown() {
  var t = $(".timer");

  if (parseInt(t.val(), 10) > 0 && counting === true)
  {
    t.val(parseInt(t.val(), 10) - 1);
    window.setTimeout(countDown, 1000);
  } else

  {
    $(".play-btn").click();
    t.val(60);
  }
}

/* Tap tempo */
$(".tap-btn").click(function () {
  var d = new Date();
  var temp = parseInt(d.getTime(), 10);

  $(".bpm-input").val(Math.ceil(60000 / (temp - delta)));
  delta = temp;
});

/* Add or subtract bpm */
$(".bpm-minus, .bpm-plus").click(function () {
  if ($(this).hasClass("bpm-minus"))
  $(".bpm-input").val(parseInt($(".bpm-input").val(), 10) - 1);else

  $(".bpm-input").val(parseInt($(".bpm-input").val(), 10) + 1);
});

/* Change pitches for tones in options */
$(".beat-range, .accent-range").change(function () {
  if ($(this).hasClass("beat-range"))
  offBeatPitch = $(this).val();else

  accentPitch = $(this).val();
});

/* Activate dots for accents */
$(document).on("click", ".counter .dot", function () {
  $(this).toggleClass("active");
});

$(".options-btn").click(function () {
  $(".options").toggleClass("options-active");
});

/* Add dots when time signature is changed */
$(".ts-top, .ts-bottom").on("change", function () {
  var _counter = $(".counter");
  _counter.html("");

  for (var i = 0; i < parseInt($(".ts-top").val(), 10); i++)
  {if (window.CP.shouldStopExecution(1)) break;
    var temp = document.createElement("div");
    temp.className = "dot";

    if (i === 0)
    temp.className += " active";

    _counter.append(temp);
  }window.CP.exitedLoop(1);
});


/* Play and stop button */
$(".play-btn").click(function () {
  if ($(this).data("what") === "pause")
  {
    // ====== Pause ====== //
    counting = false;
    window.clearInterval(timer);
    $(".counter .dot").attr("style", "");
    $(this).data("what", "play").attr("style", "").text("Play");
  } else
  {
    // ====== Play ====== //

    if ($("#timer-check").is(":checked"))
    {
      counting = true;
      countDown();
    }

    curTime = context.currentTime;
    noteCount = parseInt($(".ts-top").val(), 10);
    schedule();

    $(this).data("what", "pause").css({
      background: "#F75454",
      color: "#FFF" }).
    text("Stop");
  }
});
//# sourceURL=pen.js
    </script>

  

</body>

</html>
 
